
# Mudskipper-contract

> Mudskipper

Mudskipper는 크로스 체인 스왑 (애그리게이팅) 서비스입니다. 유저에게 한쪽 체인에서 입금을 받으면, 경로상의 트랜젝션(스왑, 브릿지 등)을 백단에서 수행하여 도착지의 주소에 결과물을 전달하는 서비스입니다.

LiFi에서 착안하였으며, LiFi 미지원 체인을 포함하고 유저가 직접 각 체인에 네트워크 에셋을 준비하고 트랜젝션을 수행하는 번거로움을 개선하기 위한 프로젝트입니다.

> Service flow

대표적인 경우인 유저가 스왑을 수행할 때 플로우는 다음과 같습니다.

+ 유저는 클라이언트에서 시작 체인, 토큰, 개수, 도착 체인과 토큰 등을 지정합니다.

+ 백엔드는 경로를 제안하고 유저가 선택한 경로에 대해 요청 티켓을 만들고 서명합니다. 티켓에는 유니크한 nonce, 입금액, 유효시간, 경로 등이 포함됩니다.

+ 유저는 백엔드로부터 전달받은 티켓, 티켓에 대한 서명을 포함하여 Mudskipper 컨트랙의 requestTransfer를 호출하여 시작 토큰을 입금합니다.

+ 컨트랙은 티켓이 백엔드에서 발급된 것이 맞는지 서명을 확인하고, 실제 입금액과 티켓상 입금액이 일치하는지 등 유효성을 확인한 다음 이벤트를 발생시킵니다.

+ 백엔드는 발생한 입금 이벤트를 감지하고 티켓을 조회하여 발급한 이력, 입금된 금액이나 만료 시간 이내인지 등 유효성을 검증합니다.

+ 백엔드 릴레이어는 요청 사항에 따라 일련의 트랜젝션을 수행합니다.

    + swap : 체인 내에서 스왑만 수행하는 경우
    + swapAndUnaBridge : 스왑 후 우나브릿지를 이용하는 경우
    + bridgeViaLiFi : LiFi를 통해 브릿지나 스왑을 수행하는 경우 등

+ 릴레이어가 경로상의 마지막 트랜젝션까지 수행하고 나면 유저는 도착 토큰을 수령하게 됩니다. 

> Logic Contract

이를 위하여 각 체인별로 아래와 같이 네가지의 컨트랙을 사용합니다.

+ /contracts/Mudskipper/mudskipper.sol : 유저의 입금을 받고, 백엔드의 요구에 따라 스왑, 브릿지 등 트랜젝션을 단일화하여 수행합니다.
+ /contracts/Mudskipper/reserve.sol : 백엔드의 트랜젝션 수행을 위한 자금(가스비)을 보관하는 곳입니다. 정해진 주기마다 일정 금액까지 출금이 가능합니다.
+ /contracts/Mudskipper/vault.sol : 유저에게 받은 수수료 중 수익분을 보관하는 곳입니다. 이 자금은 정해진 비율에 따라 각 주소로 분배됩니다.
+ /contracts/Mudskipper/buffer.sol : 유저에게 받은 수수료 나머지를 보관하는 곳입니다. 이 자금은 이후 리저브가 부족한 다른 체인이나 현재 체인의 리저브로 이동됩니다.

> Authority

컨트랙에 대한 플레이어별 권한은 다음과 같이 설정되어 있습니다.

+ 수동
    + MUDSKIPPER_MANAGER : 컨트랙 주소 등 메인 컨트랙의 설정을 관리합니다.
    + VAULT_MANAGER : 보관된 수익을 분배하거나, 분배 비율 등을 결정할 수 있습니다.
    + POOL_MANAGER : 리저브 풀의 설정을 관리하고 버퍼의 금액에 대한 권한이 있습니다.

+ 백엔드
    + TICKET_PUBLISHER : 티켓을 발급할 수 있는 권한이 있는 백엔드입니다.
    + TX_RELAYER : 리저브에서 가스비를 수령할 수 있고, 메인 컨트랙에서 스왑이나 브릿지에 관련된 트랜젝션을 실행할 수 있습니다.

> Folder

폴더별 간단한 설명은 아래와 같습니다.

+ ./contracts/Mudskipper : 상기한 서비스 컨트랙트
+ ./contracts/Interface : 컨트랙 인터페이스
+ ./contracts/Mock : 테스트를 위한 모킹 컨트랙
+ ./contracts/Utils : Factory, Proxy 등 유틸리티성 컨트랙
+ ./scripts : 배포나 디버그, 컨트랙 설정 등을 위한 스크립트 파일
+ ./test/01_mudskipper : 컨트랙별 기초적인 내용을 테스트하는 파일
+ ./test/02_fork : 여러 체인 환경에서 테스트 하기 위한 파일
